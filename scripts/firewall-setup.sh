#!/bin/bash
# firewall-setup.sh - Настройка файрвола для архитектуры xHTTP + TLS 1.2

echo "Настройка файрвола для архитектуры xHTTP + TLS 1.2..."

# Проверка прав root
if [ "$EUID" -ne 0 ]; then
    echo "Ошибка: Запустите скрипт с правами root (sudo)"
    exit 1
fi

# Разрешить входящие соединения на порт 443 (TLS + xHTTP)
ufw allow 443/tcp
echo "✓ Разрешен входящий трафик на порт 443"

# Разрешить исходящие соединения на порт 443
ufw allow out 443/tcp
echo "✓ Разрешен исходящий трафик на порт 443"

# Заблокировать прямой доступ к внутреннему порту Xray извне
ufw deny 10000/tcp
echo "✓ Заблокирован прямой доступ к порту 10000 извне"

# Разрешить локальные соединения на порт 10000 (только для Nginx)
ufw allow from 127.0.0.1 to any port 10000
echo "✓ Разрешен локальный доступ к порту 10000 (127.0.0.1)"

# Разрешить SSH (если не настроен)
ufw allow 22/tcp
echo "✓ Разрешен SSH доступ"

# Включить файрвол
ufw --force enable
echo "✓ Файрвол включен"

echo ""
echo "Настройка файрвола завершена:"
echo "- Порт 443: открыт для входящих/исходящих соединений"
echo "- Порт 10000: доступен только локально (127.0.0.1)"
echo "- SSH: разрешен на порту 22"
